# ТехноМаркет — Telegram-бот-консультант для интернет-магазина электроники

## Описание

**ТехноМаркет** — это диалоговый Telegram-бот на Python (aiogram + OpenAI/Groq + SQLAlchemy), который помогает пользователям подобрать электронику по индивидуальным параметрам. Бот реализует LLM-first подход: вся логика диалога, уточнения характеристик и формирование фильтров происходит на стороне языковой модели, а Python-код только парсит параметры и ищет товары в базе.

---

## Основная логика работы

- **LLM-first**: бот ведёт диалог, сам уточняет параметры (бюджет, бренд, цвет, память, размер экрана и т.д.), формирует блок фильтров по шаблону.
- **Ассортимент**: категории и товары хранятся в PostgreSQL, фото — только локально в папке `images/<Категория>/`. В базе у каждого товара поле `image_url` строго вида `images/<Категория>/<Категория>_N.jpg`.
- **История**: все сообщения пользователя и ассистента сохраняются в БД, бот всегда учитывает историю диалога.
- **Контекст**: все требования к поведению, формату фильтров, альтернативам и выдаче товаров описаны в `src/context.txt` и подгружаются для LLM.
- **Фото**: в основном ответе фото не показывается, только по отдельному запросу пользователя ("фото 1", "фото Xiaomi"). Фото отправляется из папки `images/` через FSInputFile.
- **Фильтрация**: бот фильтрует товары по всем параметрам из блока "Параметры поиска" (категория, бренд, цена, цвет, память и т.д.). Фильтрация по цвету ищет совпадения и в названии, и в описании товара.
- **Fallback и альтернативы**: если по фильтрам ничего не найдено, LLM сама сообщает об этом пользователю и предлагает альтернативы с пояснением (например, другой цвет, больший объём памяти, чуть выше цена).
- **Строгий LLM-контекст**: LLM обязана всегда повторять все ранее указанные фильтры (цвет, бюджет, память и т.д.), если пользователь не отменил их явно. Строка "Параметры поиска" используется только для ассистента и не показывается пользователю.

---

## Требования к LLM (см. context.txt)
- Всегда уточняй параметры, если пользователь не указал их явно.
- Не предлагай товары из других категорий, если пользователь не просил.
- Всегда возвращай фильтры по одному шаблону: категория, бренд, цена, цвет, память и т.д.
- Если пользователь указывает размытые характеристики ("средний экран"), сам подставляй конкретные значения.
- Если по фильтрам ничего не найдено — сообщи об этом и предложи альтернативы с пояснением.
- Никогда не предлагай товары, которые не соответствуют фильтрам, без явного пояснения, что это альтернатива.
- Строку "Параметры поиска: ..." используй только для ассистента, не выводи её пользователю.

---

## Работа с фото
- Все фото товаров — только локальные, лежат в папке `images/<Категория>/`.
- В базе у каждого товара поле `image_url` строго вида `images/<Категория>/<Категория>_N.jpg`.
- Фото отправляется только по отдельному запросу пользователя ("фото 1", "фото Xiaomi").

---

## Хранение истории и состояния
- Все сообщения пользователя и ассистента сохраняются в таблице `messages`.
- Для каждого пользователя в `user.extra_data` хранится состояние диалога, последние товары, выбранная категория и т.д.

---

## Запуск и настройка

1. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```
2. **Настройте переменные окружения:**
   - `BOT_TOKEN` — токен Telegram-бота
   - `OPENAI_API_KEY` или `GROQ_API_KEY` — ключ для LLM
   - `DATABASE_URL` — строка подключения к PostgreSQL
3. **Запустите миграции Alembic:**
   ```bash
   alembic upgrade head
   ```
4. **Скачайте фото для ассортимента:**
   ```bash
   python src/download_images.py
   ```
5. **Запустите бота:**
   ```bash
   python src/bot.py
   ```

---

## Пример диалога

Пользователь: Хочу смартфон
Бот: Подскажите, пожалуйста, какой у вас бюджет и какие бренды предпочитаете? Есть ли важные характеристики (например, размер экрана, камера)?
Пользователь: До 35 тысяч, интересуют чёрные модели 128 гигов
Бот: К сожалению, среди чёрных смартфонов с 128 ГБ памяти до 35 тысяч рублей сейчас нет подходящих моделей. Вот альтернативные варианты с большим объёмом памяти или в другом цвете: ...

---

## Особенности
- LLM-first: Python-код не "додумывает" фильтры, а только парсит готовые значения.
- Гибкая архитектура: легко добавить новые категории, параметры, бренды.
- Устойчивость к размытым и неполным запросам пользователя.
- Максимально дружелюбный и профессиональный стиль общения.

---

## Контакты

Разработчик: [Ваше имя или ник]

---

**Внимание:** бот тестовый, фото товаров не настоящие, заказы не обрабатываются!
